jeff [ ~ ]$ ./DeployNessusToVMs.sh 
+ command -v jq
+ command -v curl
+ storageAccountName=azagentdeploy001
+ storageContainerName=scripts
+ allowed_vms_csv=AzureVirtualMachines.csv
+ local_csv_path=/tmp/AzureVirtualMachines.csv
+ management_subscription=b56097b7-e22e-46fc-92b9-da53cb50cb23
+ echo 'Switching to subscription: b56097b7-e22e-46fc-92b9-da53cb50cb23'
Switching to subscription: b56097b7-e22e-46fc-92b9-da53cb50cb23
+ az account set --subscription b56097b7-e22e-46fc-92b9-da53cb50cb23
+ echo 'Retrieving storage account key for: azagentdeploy001'
Retrieving storage account key for: azagentdeploy001
++ az storage account keys list --resource-group rg-inf-scripts-001 --account-name azagentdeploy001 --query '[0].value' --output tsv
WARNING: [Warning] This output may compromise security by showing secrets. Learn more at: https://go.microsoft.com/fwlink/?linkid=2258669
+ echo 'Storage account key retrieved successfully.'
Storage account key retrieved successfully.
+ export AZURE_STORAGE_ACCOUNT=azagentdeploy001
+ AZURE_STORAGE_ACCOUNT=azagentdeploy001
+ echo 'Generating SAS token for storage account.'
Generating SAS token for storage account.
+++ date -u -d '1 day' +%Y-%m-%dT%H:%MZ
++ az storage account generate-sas --account-name azagentdeploy001 --permissions rl --resource-types sco --services b --expiry 2024-06-26T22:25Z --output tsv
WARNING: [Warning] This output may compromise security by showing secrets. Learn more at: https://go.microsoft.com/fwlink/?linkid=2258669
+ sas_token='se=2024-06-26T22%3A25Z&sp=rl&sv=2022-11-02&ss=b&srt=sco&sig=RT8nkNKN1QaTtN1dXh2gEn4MStn1ZjRCMkrpJ3nSl6c%3D'
+ '[' -z 'se=2024-06-26T22%3A25Z&sp=rl&sv=2022-11-02&ss=b&srt=sco&sig=RT8nkNKN1QaTtN1dXh2gEn4MStn1ZjRCMkrpJ3nSl6c%3D' ']'
+ echo 'SAS token generated successfully.'
SAS token generated successfully.
+ blob_service_endpoint=https://azagentdeploy001.blob.core.usgovcloudapi.net
+ csv_url='https://azagentdeploy001.blob.core.usgovcloudapi.net/scripts/AzureVirtualMachines.csv?se=2024-06-26T22%3A25Z&sp=rl&sv=2022-11-02&ss=b&srt=sco&sig=RT8nkNKN1QaTtN1dXh2gEn4MStn1ZjRCMkrpJ3nSl6c%3D'
+ echo 'Downloading CSV from URL: https://azagentdeploy001.blob.core.usgovcloudapi.net/scripts/AzureVirtualMachines.csv?se=2024-06-26T22%3A25Z&sp=rl&sv=2022-11-02&ss=b&srt=sco&sig=RT8nkNKN1QaTtN1dXh2gEn4MStn1ZjRCMkrpJ3nSl6c%3D'
Downloading CSV from URL: https://azagentdeploy001.blob.core.usgovcloudapi.net/scripts/AzureVirtualMachines.csv?se=2024-06-26T22%3A25Z&sp=rl&sv=2022-11-02&ss=b&srt=sco&sig=RT8nkNKN1QaTtN1dXh2gEn4MStn1ZjRCMkrpJ3nSl6c%3D
+ curl -o /tmp/AzureVirtualMachines.csv 'https://azagentdeploy001.blob.core.usgovcloudapi.net/scripts/AzureVirtualMachines.csv?se=2024-06-26T22%3A25Z&sp=rl&sv=2022-11-02&ss=b&srt=sco&sig=RT8nkNKN1QaTtN1dXh2gEn4MStn1ZjRCMkrpJ3nSl6c%3D'
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   246  100   246    0     0   3456      0 --:--:-- --:--:-- --:--:--  3464
+ '[' '!' -f /tmp/AzureVirtualMachines.csv ']'
+ echo 'CSV file downloaded successfully.'
CSV file downloaded successfully.
+ read_allowed_vms
+ allowed_vms=()
+ IFS=,
+ read -r name type subscription resourceGroup location status operatingSystem size publicIpAddress disks
+ [[ <?xml version="1.0" encoding="utf-8"?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation. != \N\A\M\E ]]
+ allowed_vms+=("$(echo "$name" | xargs),$(echo "$subscription" | xargs),$(echo "$resourceGroup" | xargs)")
++ echo '<?xml version="1.0" encoding="utf-8"?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
++ xargs
++ echo ''
++ xargs
++ echo ''
++ xargs
+ IFS=,
+ read -r name type subscription resourceGroup location status operatingSystem size publicIpAddress disks
+ [[ RequestId:0b72b880-b01e-0008-084e-c7bd49000000 != \N\A\M\E ]]
+ allowed_vms+=("$(echo "$name" | xargs),$(echo "$subscription" | xargs),$(echo "$resourceGroup" | xargs)")
++ xargs
++ echo RequestId:0b72b880-b01e-0008-084e-c7bd49000000
++ echo ''
++ xargs
++ echo ''
++ xargs
+ IFS=,
+ read -r name type subscription resourceGroup location status operatingSystem size publicIpAddress disks
+ nessusAgentWindows=NessusAgent-10.6.4-x64.msi
+ nessusAgentUbuntu=NessusAgent-10.6.4-ubuntu1404_amd64.deb
+ nessusAgentRHEL=NessusAgent-10.6.4-el8.x86_64.rpm
++ az account list --query '[?state=='\''Enabled'\''].id' -o tsv
+ subscriptions='5e2ccec2-02a9-481f-8a00-aa5440e574b3
b56097b7-e22e-46fc-92b9-da53cb50cb23
c38137e9-2c7c-4c88-bb0c-c7bfe6e1872b
29b04b2f-b64c-4792-890a-76d9617a18e1
4c437c4a-e51d-448e-a2d1-8ca3383bee8b
910857c3-85ff-44ba-be55-b4b3093cfdbe
b0844a47-03c6-4a40-8c24-aa62a617a936
dbef0776-721c-428b-bdc1-fa90085dbf6f
e873319e-be73-4ac2-a683-b2c291fc4767'
+ for subscription in $subscriptions
+ az account set --subscription 5e2ccec2-02a9-481f-8a00-aa5440e574b3
++ az vm list --query '[].{name:name, resourceGroup:resourceGroup, osType:storageProfile.osDisk.osType}' -o json
+ vms='[
  {
    "name": "vmcnctjmpbx-001",
    "osType": "Windows",
    "resourceGroup": "RG-CNCT-JMPBX-001"
  },
  {
    "name": "vmcnctjmpbx-002",
    "osType": "Windows",
    "resourceGroup": "RG-CNCT-JMPBX-002"
  },
  {
    "name": "vmpalofw001",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmpalofw002",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmt1palongfw001",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmt1palongfw002",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmzscappcnct01",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-ZSCAL-001"
  },
  {
    "name": "vmzscappcnct02",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-ZSCAL-001"
  },
  {
    "name": "vmzscappcnct03",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-ZSCAL-001"
  }
]'
++ jq -c '.[]'
++ echo '[
  {
    "name": "vmcnctjmpbx-001",
    "osType": "Windows",
    "resourceGroup": "RG-CNCT-JMPBX-001"
  },
  {
    "name": "vmcnctjmpbx-002",
    "osType": "Windows",
    "resourceGroup": "RG-CNCT-JMPBX-002"
  },
  {
    "name": "vmpalofw001",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmpalofw002",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmt1palongfw001",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmt1palongfw002",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-PALO-001"
  },
  {
    "name": "vmzscappcnct01",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-ZSCAL-001"
  },
  {
    "name": "vmzscappcnct02",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-ZSCAL-001"
  },
  {
    "name": "vmzscappcnct03",
    "osType": "Linux",
    "resourceGroup": "RG-CNCT-ZSCAL-001"
  }
]'
+ for vm in $(echo "$vms" | jq -c '.[]')
++ echo '{"name":"vmcnctjmpbx-001","osType":"Windows","resourceGroup":"RG-CNCT-JMPBX-001"}'
++ xargs
++ jq -r .name
+ vmName=vmcnctjmpbx-001
++ echo '{"name":"vmcnctjmpbx-001","osType":"Windows","resourceGroup":"RG-CNCT-JMPBX-001"}'
++ jq -r .resourceGroup
++ xargs
+ resourceGroup=RG-CNCT-JMPBX-001
++ echo '{"name":"vmcnctjmpbx-001","osType":"Windows","resourceGroup":"RG-CNCT-JMPBX-001"}'
++ jq -r .osType
++ xargs
+ osType=Windows
+ echo 'Processing VM: vmcnctjmpbx-001, Resource Group: RG-CNCT-JMPBX-001, OS Type: Windows'
Processing VM: vmcnctjmpbx-001, Resource Group: RG-CNCT-JMPBX-001, OS Type: Windows
++ is_vm_allowed vmcnctjmpbx-001
++ local vm_name=vmcnctjmpbx-001
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\'''
++ [[ vmcnctjmpbx-001 == \\<\?\x\m\l\ \v\e\r\s\i\o\n\=\1\.\0\ \e\n\c\o\d\i\n\g\=\u\t\f\-\8\?\>\<\e\r\r\o\r\>\<\c\o\d\e\>\a\u\t\h\o\r\i\z\a\t\i\o\n\f\a\i\l\u\r\e\<\/\c\o\d\e\>\<\m\e\s\s\a\g\e\>\t\h\i\s\ \r\e\q\u\e\s\t\ \i\s\ \n\o\t\ \a\u\t\h\o\r\i\z\e\d\ \t\o\ \p\e\r\f\o\r\m\ \t\h\i\s\ \o\p\e\r\a\t\i\o\n\. ]]
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ [[ vmcnctjmpbx-001 == \r\e\q\u\e\s\t\i\d\:\0\b\7\2\b\8\8\0\-\b\0\1\e\-\0\0\0\8\-\0\8\4\e\-\c\7\b\d\4\9\0\0\0\0\0\0 ]]
++ echo ''
++ return 1
+ allowed_vm_info='Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ '[' -n 'Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''' ']'
++ echo 'Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ cut -d, -f1
+ allowed_vm_subscription='Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ echo 'Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ cut -d, -f2
+ allowed_vm_resourceGroup='Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ echo 'VM vmcnctjmpbx-001 is allowed, processing...'
VM vmcnctjmpbx-001 is allowed, processing...
+ echo 'Switching to subscription: Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
Switching to subscription: Comparing VM 'vmcnctjmpbx-001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'
+ az account set --subscription 'Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
The subscription of 'comparing vm 'vmcnctjmpbx-001' with allowed vm '<?xml version=1.0 encoding=utf-8?><error><code>authorizationfailure</code><message>this request is not authorized to perform this operation.'
comparing vm 'vmcnctjmpbx-001' with allowed vm 'requestid:0b72b880-b01e-0008-084e-c7bd49000000'' doesn't exist in cloud 'AzureUSGovernment'.
+ echo 'Checking if resource group Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'' exists in subscription Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''...'
Checking if resource group Comparing VM 'vmcnctjmpbx-001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000' exists in subscription Comparing VM 'vmcnctjmpbx-001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'...
+ az group exists --name 'Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
Operation returned an invalid status 'Bad Request'
+ echo 'Resource group Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'' does not exist in subscription Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''.'
Resource group Comparing VM 'vmcnctjmpbx-001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000' does not exist in subscription Comparing VM 'vmcnctjmpbx-001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'.
+ for vm in $(echo "$vms" | jq -c '.[]')
++ xargs
++ jq -r .name
++ echo '{"name":"vmcnctjmpbx-002","osType":"Windows","resourceGroup":"RG-CNCT-JMPBX-002"}'
+ vmName=vmcnctjmpbx-002
++ echo '{"name":"vmcnctjmpbx-002","osType":"Windows","resourceGroup":"RG-CNCT-JMPBX-002"}'
++ jq -r .resourceGroup
++ xargs
+ resourceGroup=RG-CNCT-JMPBX-002
++ jq -r .osType
++ echo '{"name":"vmcnctjmpbx-002","osType":"Windows","resourceGroup":"RG-CNCT-JMPBX-002"}'
++ xargs
+ osType=Windows
+ echo 'Processing VM: vmcnctjmpbx-002, Resource Group: RG-CNCT-JMPBX-002, OS Type: Windows'
Processing VM: vmcnctjmpbx-002, Resource Group: RG-CNCT-JMPBX-002, OS Type: Windows
++ is_vm_allowed vmcnctjmpbx-002
++ local vm_name=vmcnctjmpbx-002
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\'''
++ [[ vmcnctjmpbx-002 == \\<\?\x\m\l\ \v\e\r\s\i\o\n\=\1\.\0\ \e\n\c\o\d\i\n\g\=\u\t\f\-\8\?\>\<\e\r\r\o\r\>\<\c\o\d\e\>\a\u\t\h\o\r\i\z\a\t\i\o\n\f\a\i\l\u\r\e\<\/\c\o\d\e\>\<\m\e\s\s\a\g\e\>\t\h\i\s\ \r\e\q\u\e\s\t\ \i\s\ \n\o\t\ \a\u\t\h\o\r\i\z\e\d\ \t\o\ \p\e\r\f\o\r\m\ \t\h\i\s\ \o\p\e\r\a\t\i\o\n\. ]]
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ [[ vmcnctjmpbx-002 == \r\e\q\u\e\s\t\i\d\:\0\b\7\2\b\8\8\0\-\b\0\1\e\-\0\0\0\8\-\0\8\4\e\-\c\7\b\d\4\9\0\0\0\0\0\0 ]]
++ echo ''
++ return 1
+ allowed_vm_info='Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ '[' -n 'Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''' ']'
++ cut -d, -f1
++ echo 'Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ allowed_vm_subscription='Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ cut -d, -f2
++ echo 'Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ allowed_vm_resourceGroup='Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ echo 'VM vmcnctjmpbx-002 is allowed, processing...'
VM vmcnctjmpbx-002 is allowed, processing...
+ echo 'Switching to subscription: Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
Switching to subscription: Comparing VM 'vmcnctjmpbx-002' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-002' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'
+ az account set --subscription 'Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
The subscription of 'comparing vm 'vmcnctjmpbx-002' with allowed vm '<?xml version=1.0 encoding=utf-8?><error><code>authorizationfailure</code><message>this request is not authorized to perform this operation.'
comparing vm 'vmcnctjmpbx-002' with allowed vm 'requestid:0b72b880-b01e-0008-084e-c7bd49000000'' doesn't exist in cloud 'AzureUSGovernment'.
+ echo 'Checking if resource group Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'' exists in subscription Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''...'
Checking if resource group Comparing VM 'vmcnctjmpbx-002' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-002' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000' exists in subscription Comparing VM 'vmcnctjmpbx-002' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-002' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'...
+ az group exists --name 'Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
Operation returned an invalid status 'Bad Request'
+ echo 'Resource group Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'' does not exist in subscription Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmcnctjmpbx-002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''.'
Resource group Comparing VM 'vmcnctjmpbx-002' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-002' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000' does not exist in subscription Comparing VM 'vmcnctjmpbx-002' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmcnctjmpbx-002' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'.
+ for vm in $(echo "$vms" | jq -c '.[]')
++ xargs
++ jq -r .name
++ echo '{"name":"vmpalofw001","osType":"Linux","resourceGroup":"RG-CNCT-PALO-001"}'
+ vmName=vmpalofw001
++ jq -r .resourceGroup
++ xargs
++ echo '{"name":"vmpalofw001","osType":"Linux","resourceGroup":"RG-CNCT-PALO-001"}'
+ resourceGroup=RG-CNCT-PALO-001
++ echo '{"name":"vmpalofw001","osType":"Linux","resourceGroup":"RG-CNCT-PALO-001"}'
++ xargs
++ jq -r .osType
+ osType=Linux
+ echo 'Processing VM: vmpalofw001, Resource Group: RG-CNCT-PALO-001, OS Type: Linux'
Processing VM: vmpalofw001, Resource Group: RG-CNCT-PALO-001, OS Type: Linux
++ is_vm_allowed vmpalofw001
++ local vm_name=vmpalofw001
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\'''
++ [[ vmpalofw001 == \\<\?\x\m\l\ \v\e\r\s\i\o\n\=\1\.\0\ \e\n\c\o\d\i\n\g\=\u\t\f\-\8\?\>\<\e\r\r\o\r\>\<\c\o\d\e\>\a\u\t\h\o\r\i\z\a\t\i\o\n\f\a\i\l\u\r\e\<\/\c\o\d\e\>\<\m\e\s\s\a\g\e\>\t\h\i\s\ \r\e\q\u\e\s\t\ \i\s\ \n\o\t\ \a\u\t\h\o\r\i\z\e\d\ \t\o\ \p\e\r\f\o\r\m\ \t\h\i\s\ \o\p\e\r\a\t\i\o\n\. ]]
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ [[ vmpalofw001 == \r\e\q\u\e\s\t\i\d\:\0\b\7\2\b\8\8\0\-\b\0\1\e\-\0\0\0\8\-\0\8\4\e\-\c\7\b\d\4\9\0\0\0\0\0\0 ]]
++ echo ''
++ return 1
+ allowed_vm_info='Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ '[' -n 'Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''' ']'
++ echo 'Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
++ cut -d, -f1
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ allowed_vm_subscription='Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ echo 'Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ cut -d, -f2
+ allowed_vm_resourceGroup='Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ echo 'VM vmpalofw001 is allowed, processing...'
VM vmpalofw001 is allowed, processing...
+ echo 'Switching to subscription: Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
Switching to subscription: Comparing VM 'vmpalofw001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmpalofw001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'
+ az account set --subscription 'Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
The subscription of 'comparing vm 'vmpalofw001' with allowed vm '<?xml version=1.0 encoding=utf-8?><error><code>authorizationfailure</code><message>this request is not authorized to perform this operation.'
comparing vm 'vmpalofw001' with allowed vm 'requestid:0b72b880-b01e-0008-084e-c7bd49000000'' doesn't exist in cloud 'AzureUSGovernment'.
+ echo 'Checking if resource group Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'' exists in subscription Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''...'
Checking if resource group Comparing VM 'vmpalofw001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmpalofw001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000' exists in subscription Comparing VM 'vmpalofw001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmpalofw001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'...
+ az group exists --name 'Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
Operation returned an invalid status 'Bad Request'
+ echo 'Resource group Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'' does not exist in subscription Comparing VM '\''vmpalofw001'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw001'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''.'
Resource group Comparing VM 'vmpalofw001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmpalofw001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000' does not exist in subscription Comparing VM 'vmpalofw001' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmpalofw001' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'.
+ for vm in $(echo "$vms" | jq -c '.[]')
++ jq -r .name
++ echo '{"name":"vmpalofw002","osType":"Linux","resourceGroup":"RG-CNCT-PALO-001"}'
++ xargs
+ vmName=vmpalofw002
++ echo '{"name":"vmpalofw002","osType":"Linux","resourceGroup":"RG-CNCT-PALO-001"}'
++ jq -r .resourceGroup
++ xargs
+ resourceGroup=RG-CNCT-PALO-001
++ jq -r .osType
++ xargs
++ echo '{"name":"vmpalofw002","osType":"Linux","resourceGroup":"RG-CNCT-PALO-001"}'
+ osType=Linux
+ echo 'Processing VM: vmpalofw002, Resource Group: RG-CNCT-PALO-001, OS Type: Linux'
Processing VM: vmpalofw002, Resource Group: RG-CNCT-PALO-001, OS Type: Linux
++ is_vm_allowed vmpalofw002
++ local vm_name=vmpalofw002
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\'''
++ [[ vmpalofw002 == \\<\?\x\m\l\ \v\e\r\s\i\o\n\=\1\.\0\ \e\n\c\o\d\i\n\g\=\u\t\f\-\8\?\>\<\e\r\r\o\r\>\<\c\o\d\e\>\a\u\t\h\o\r\i\z\a\t\i\o\n\f\a\i\l\u\r\e\<\/\c\o\d\e\>\<\m\e\s\s\a\g\e\>\t\h\i\s\ \r\e\q\u\e\s\t\ \i\s\ \n\o\t\ \a\u\t\h\o\r\i\z\e\d\ \t\o\ \p\e\r\f\o\r\m\ \t\h\i\s\ \o\p\e\r\a\t\i\o\n\. ]]
++ for allowed_vm in "${allowed_vms[@]}"
++ IFS=,
++ read -r allowed_vm_name allowed_vm_subscription allowed_vm_resourceGroup
++ echo 'Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ [[ vmpalofw002 == \r\e\q\u\e\s\t\i\d\:\0\b\7\2\b\8\8\0\-\b\0\1\e\-\0\0\0\8\-\0\8\4\e\-\c\7\b\d\4\9\0\0\0\0\0\0 ]]
++ echo ''
++ return 1
+ allowed_vm_info='Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ '[' -n 'Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\''' ']'
++ cut -d, -f1
++ echo 'Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ allowed_vm_subscription='Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
++ echo 'Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
++ cut -d, -f2
Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ allowed_vm_resourceGroup='Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
+ echo 'VM vmpalofw002 is allowed, processing...'
VM vmpalofw002 is allowed, processing...
+ echo 'Switching to subscription: Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'\''
Comparing VM '\''vmpalofw002'\'' with allowed VM '\''RequestId:0b72b880-b01e-0008-084e-c7bd49000000'\'''
Switching to subscription: Comparing VM 'vmpalofw002' with allowed VM '<?xml version=1.0 encoding=utf-8?><Error><Code>AuthorizationFailure</Code><Message>This request is not authorized to perform this operation.'
Comparing VM 'vmpalofw002' with allowed VM 'RequestId:0b72b880-b01e-0008-084e-c7bd49000000'
+ az account set --subscription 'Comparing VM '\''vmpalofw002'\'' with allowed VM '\''<?xml version=1.0 encoding=utf-8?><Error><Codv
